<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="ë¯¸êµ­ ê²½ê¸°ì¹¨ì²´ ì‹œê¸°ì™€ S&P500 ì§€ìˆ˜ì˜ ë³€í™”ë¥¼ ë¹„êµ ë¶„ì„í•˜ëŠ” ì¸í„°ë™í‹°ë¸Œ ê·¸ë˜í”„ ë„êµ¬. ë¦¬ì„¸ì…˜ë³„ ì§€ìˆ˜ ë³€í™”ìœ¨ê³¼ ìµœëŒ€ ë‚™í­(MDD)ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
  <title>S&P500 ì§€ìˆ˜ì™€ ê²½ê¸°ì¹¨ì²´</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="price_daily.js"></script>
</head>
<body>

  <div id="nav-placeholder"></div>
  <script>
    fetch("includes/nav.html")
      .then(res => res.text())
      .then(data => document.getElementById("nav-placeholder").innerHTML = data);
  </script>
  
  <div class="card">
    <h1>ğŸ“‰ S&P500 ì§€ìˆ˜ì™€ ë¯¸êµ­ ê²½ê¸°ì¹¨ì²´ ì‹œê¸°</h1>
  <p class="note">
    ë¯¸êµ­ ê²½ê¸°ì¹¨ì²´ ì‹œê¸°ì™€ S&P500 ì§€ìˆ˜ì˜ ë³€í™”ë¥¼ ë¹„êµ ë¶„ì„í•©ë‹ˆë‹¤.
  </p>
    <section class="inputs">
      <table>
        <tr>
          <th>â³ ì‹œì‘ ì—°ë„</th>
          <td><input type="number" id="startYear" value="2000" /></td>
        </tr>
        <tr>
          <th>â±ï¸ ì¢…ë£Œ ì—°ë„</th>
          <td><input type="number" id="endYear" value="2024" /></td>
        </tr>
        <tr>
          <th>ğŸ“ Yì¶• ìŠ¤ì¼€ì¼</th>
          <td>
            <label><input type="radio" name="scaleType" value="linear" checked /> ì„ í˜•</label>
            <label><input type="radio" name="scaleType" value="logarithmic" /> ë¡œê·¸</label>
          </td>
        </tr>
      </table>
      <div style="text-align:center; margin-top:15px;">
        <button onclick="drawRecessionChart()">ğŸ“Š ê·¸ë˜í”„ ê·¸ë¦¬ê¸°</button>
      </div>
    </section>

    <div class="chart-wrapper">
      <canvas id="spChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <canvas id="drawdownChart"></canvas>
    </div>
    <div id="summaryBox" class="card" style="margin-top: 20px;"></div>
  </div>

  <script>
    const recessionPeriods = [
      { xMin: '1929-08-01', xMax: '1933-03-01', label: "1929ë…„ ëŒ€ê³µí™©", description: "ë¯¸êµ­ ì—­ì‚¬ìƒ ìµœì•…ì˜ ê²½ê¸°ì¹¨ì²´. ì‹¤ì—…ë¥  25%, GDP 40% ê°ì†Œ." },
      { xMin: '1937-05-01', xMax: '1938-06-01', label: "1937~38 ì¹¨ì²´", description: "ê¸´ì¶• ì •ì±…ê³¼ ì†Œë¹„ ë‘”í™”ë¡œ ì´‰ë°œëœ ì¹¨ì²´." },
      { xMin: '1945-02-01', xMax: '1945-10-01', label: "1945 ì „í›„ ì¹¨ì²´", description: "2ì°¨ ì„¸ê³„ëŒ€ì „ ì¢…ë£Œì™€ ìƒì‚° ê°ì†Œë¡œ ì¸í•œ ê²½ê¸° ë‘”í™”." },
      { xMin: '1948-11-01', xMax: '1949-10-01', label: "1948~49 ì¹¨ì²´", description: "ì „í›„ ì¬ì¡°ì •ê³¼ í†µí™” ê¸´ì¶• ì •ì±… ì˜í–¥." },
      { xMin: '1953-07-01', xMax: '1954-05-01', label: "1953~54 ì¹¨ì²´", description: "í•œêµ­ì „ìŸ ì¢…ë£Œ í›„ ì •ë¶€ ì§€ì¶œ ê°ì†Œ." },
      { xMin: '1957-08-01', xMax: '1958-04-01', label: "1957~58 ì¹¨ì²´", description: "ê¸ˆë¦¬ ì¸ìƒê³¼ íˆ¬ì ê°ì†Œê°€ ì£¼ìš” ì›ì¸." },
      { xMin: '1960-04-01', xMax: '1961-02-01', label: "1960~61 ì¹¨ì²´", description: "ì¬ê³  ì¶•ì†Œì™€ ê³ ìš© ë‘”í™”ë¡œ ì¸í•œ ê²½ê¸°í›„í‡´." },
      { xMin: '1969-12-01', xMax: '1970-11-01', label: "1969~70 ì¹¨ì²´", description: "ì¸í”Œë ˆì´ì…˜ ì–µì œ ì •ì±…ê³¼ ì†Œë¹„ ìœ„ì¶•." },
      { xMin: '1973-11-01', xMax: '1975-03-01', label: "1973~75 ì˜¤ì¼ì‡¼í¬", description: "ì˜¤ì¼ì‡¼í¬ì™€ ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜ ë°œìƒ." },
      { xMin: '1980-01-01', xMax: '1980-07-01', label: "1980 ì¹¨ì²´", description: "ê³ ë¬¼ê°€ ëŒ€ì‘ì„ ìœ„í•œ ê¸ˆë¦¬ ì¸ìƒ, ì¹¨ì²´ ë°œìƒ." },
      { xMin: '1981-07-01', xMax: '1982-11-01', label: "1981~82 ë”ë¸”ë”¥", description: "ê³ ê¸ˆë¦¬ ì •ì±… ì§€ì†ìœ¼ë¡œ ë‘ ë²ˆì§¸ ì¹¨ì²´ ë°œìƒ." },
      { xMin: '1990-07-01', xMax: '1991-03-01', label: "1990 ì¹¨ì²´", description: "ê±¸í”„ì „, ë¶€ë™ì‚° ê±°í’ˆ ë¶•ê´´ ë“± ë³µí•© ìš”ì¸." },
      { xMin: '2001-03-01', xMax: '2001-11-01', label: "ë‹·ì»´ë²„ë¸” ë¶•ê´´", description: "IT ë²„ë¸” ë¶•ê´´ ë° 9.11 í…ŒëŸ¬ ì—¬íŒŒ." },
      { xMin: '2007-12-01', xMax: '2009-06-01', label: "2008 ê¸ˆìœµìœ„ê¸°", description: "ë¶€ë™ì‚°Â·ê¸ˆìœµì‹œì¥ ë¶•ê´´ë¡œ ê¸€ë¡œë²Œ ì¹¨ì²´." },
      { xMin: '2020-02-01', xMax: '2020-04-01', label: "ì½”ë¡œë‚˜ íŒ¬ë°ë¯¹", description: "íŒ¬ë°ë¯¹ì— ë”°ë¥¸ ê¸‰ê²©í•œ ê²½ì œ ë´‰ì‡„." }
    ];

    function makeRecessionAnnotations() {
      const anns = {};
      recessionPeriods.forEach((r, i) => {
        anns['box' + i] = {
          type: 'box',
          xMin: r.xMin,
          xMax: r.xMax,
          backgroundColor: 'rgba(200, 200, 200, 0.3)',
          borderWidth: 0,
          label: {
            content: r.label,
            display: true,
            position: 'start',
            color: '#333',
            backgroundColor: 'rgba(255,255,255,0.8)'
          }
        };
      });
      return anns;
    }

    function drawRecessionChart() {
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear = parseInt(document.getElementById("endYear").value);
      const scaleType = document.querySelector('input[name="scaleType"]:checked').value;

      const entries = Object.entries(priceData)
        .map(([date, value]) => ({ date, value: Number(value) }))
        .filter(d => {
          const year = new Date(d.date).getFullYear();
          return year >= startYear && year <= endYear;
        });

      const chartData = entries.map(e => ({ x: e.date, y: e.value }));
      let peak = -Infinity;
      const drawdowns = entries.map(e => {
        peak = Math.max(peak, e.value);
        return { x: e.date, y: (e.value - peak) / peak };
      });

      if (window.spChart instanceof Chart) {
        window.spChart.destroy();
      }
      if (window.drawdownChart instanceof Chart) {
        window.drawdownChart.destroy();
      }


      const ctx1 = document.getElementById("spChart").getContext("2d");
      const ctx2 = document.getElementById("drawdownChart").getContext("2d");

      window.spChart = new Chart(ctx1, {
        type: 'line',
        data: {
          datasets: [{
            label: 'S&P500 ì§€ìˆ˜',
            data: chartData,
            borderColor: '#007bff',
            fill: false,
            pointRadius: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', time: { unit: 'year' }, min: `${startYear}-01-01`,max: `${endYear}-12-31` },
            y: { type: scaleType, title: { display: true, text: 'ì§€ìˆ˜' } }
          },
          plugins: {
            legend: { display: true },
            annotation: { annotations: makeRecessionAnnotations() }
          }
        }
      });

      window.drawdownChart = new Chart(ctx2, {
        type: 'line',
        data: {
          datasets: [{
            label: 'S&P500 Drawdown',
            data: drawdowns,
            borderColor: '#dc3545',
            fill: true,
            backgroundColor: 'rgba(220,53,69,0.2)',
            pointRadius: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,          
          scales: {
            x: { type: 'time', time: { unit: 'year' }, min: `${startYear}-01-01`,max: `${endYear}-12-31`  },
            y: {
              type: 'linear',
              ticks: {
                callback: value => (value * 100).toFixed(0) + '%'
              },
              title: { display: true, text: 'Drawdown (%)' }
            }
          },
          plugins: {
            legend: { display: true },
            annotation: { annotations: makeRecessionAnnotations() }
          }
        }
      });

      // ğŸ‘‰ ì„¤ëª… í¬í•¨ ë¦¬ì„¸ì…˜ í‘œ ì¶œë ¥
      let recessionDetails = '';
      const includedRecessions = recessionPeriods.filter(r => {
        const rStartYear = new Date(r.xMin).getFullYear();
        const rEndYear = new Date(r.xMax).getFullYear();
        return rStartYear <= endYear && rEndYear >= startYear;
      });

      includedRecessions.forEach(r => {
        const rStart = new Date(r.xMin);
        const rEnd = new Date(r.xMax);
        const rEntries = entries.filter(e => {
          const date = new Date(e.date);
          return date >= rStart && date <= rEnd;
        });
        if (rEntries.length >= 2) {
          const rStartVal = rEntries[0].value;
          const rEndVal = rEntries.at(-1).value;
          const rChange = ((rEndVal - rStartVal) / rStartVal * 100).toFixed(2);
          const rMax = Math.max(...rEntries.map(e => e.value));
          const rMin = Math.min(...rEntries.map(e => e.value));
          const rMDD = (((rMin - rMax) / rMax) * 100).toFixed(2);

          const changeColor = rChange < 0 ? 'color: #ffc107;' : 'color: #198754;';
          const mddColor = 'color: #dc3545;';

          recessionDetails += `
            <tr>
              <td>${r.label}</td>
              <td>${r.xMin} ~ ${r.xMax}</td>
              <td>${rStartVal.toFixed(2)}</td>
              <td>${rEndVal.toFixed(2)}</td>
              <td><span style="${changeColor}">${rChange}%</span></td>
              <td><span style="${mddColor}">${rMDD}%</span></td>
              <td>${r.description}</td>
            </tr>
          `;

        }
      });

      document.getElementById('summaryBox').innerHTML = `
        <h3 style="margin-top:1.5rem;">ğŸ“‰ ë¦¬ì„¸ì…˜ ê¸°ê°„ë³„ ì§€ìˆ˜ ë³€í™” ë° ìµœëŒ€ ë‚™í­</h3>
        <table border="1" cellpadding="6" style="border-collapse: collapse; font-size: 0.9rem; width: 100%;">
          <thead style="background-color: #e9ecef; color: #212529;">
            <tr>
              <th>ë¦¬ì„¸ì…˜ ì´ë¦„</th>
              <th>ê¸°ê°„</th>
              <th>ì‹œì‘ ì§€ìˆ˜</th>
              <th>ì¢…ë£Œ ì§€ìˆ˜</th>
              <th>ì§€ìˆ˜ ë³€í™”ìœ¨</th>
              <th>ìµœëŒ€ ë‚™í­(MDD)</th>
              <th>ì„¤ëª…</th>
            </tr>
          </thead>
          <tbody>
            ${recessionDetails}
          </tbody>
        </table>
      `;

    }

    window.addEventListener("DOMContentLoaded", drawRecessionChart);
  </script>
</body>
<script>
  fetch("includes/nav.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("nav-placeholder").innerHTML = data;

      // â¬‡ï¸ ì£¼ì… í›„ toggle ì´ë²¤íŠ¸ ì—°ê²°
      const toggle = document.getElementById('navToggle');
      const links = document.getElementById('navLinks');
      toggle?.addEventListener('click', () => {
        links?.classList.toggle('active');
      });
    });
</script>
</html>
