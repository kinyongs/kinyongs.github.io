<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P500 ì§€ìˆ˜ ìƒìŠ¹ ìš”ì¸ ë¶„ì„: EPS ì„±ì¥ê³¼ PER ë³€í™”</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div id="nav-placeholder"></div>
<script>
  fetch("includes/nav.html")
    .then(response => response.text())
    .then(data => document.getElementById("nav-placeholder").innerHTML = data);
</script>

<div class="card">
  <h1>ğŸ“ˆ S&P500 ì§€ìˆ˜ ìƒìŠ¹ ìš”ì¸ ë¶„ì„: EPS ì„±ì¥ê³¼ PER ë³€í™”</h1>
  <p class="note">
    EPSëŠ” ê¸°ì—…ì˜ ì‹¤ì œ ì´ìµì„, PERì€ ì‹œì¥ì´ ì£¼ê°€ì— ë¶€ì—¬í•œ í”„ë¦¬ë¯¸ì—„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>
    ë³¸ ë¶„ì„ì€ S&P500 ì§€ìˆ˜ ìƒìŠ¹ì„ EPS ì„±ì¥ê³¼ PER ë³€í™” ê´€ì ì—ì„œ ë¶„í•´í•˜ì—¬ ì‹œê°í™”í•©ë‹ˆë‹¤.
  </p>

  <section class="inputs">
    <table>
      <tr>
        <th>â³ ì‹œì‘ ì—°ë„</th>
        <td><input type="number" id="startYear" /></td>
      </tr>
      <tr>
        <th>â±ï¸ ì¢…ë£Œ ì—°ë„</th>
        <td><input type="number" id="endYear" /></td>
      </tr>
      <tr>
        <th>ğŸ“ Yì¶• ìŠ¤ì¼€ì¼</th>
        <td>
          <label><input type="radio" name="scaleType" value="linear" checked> ì„ í˜•</label>
          <label><input type="radio" name="scaleType" value="log"> ë¡œê·¸</label>
        </td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="renderCharts()">ğŸ“Š ë¶„ì„ ì‹¤í–‰</button>
    </div>
  </section>

  <div class="chart-wrapper">
    <canvas id="chartEPS"></canvas>
  </div>

  <div class="chart-wrapper">
    <canvas id="chartPER"></canvas>
  </div>

  <section id="analysisText" class="note" style="max-width: 800px; margin: 2rem auto;"></section>
</div>

<script src="price_EPS_monthly.js"></script>
<script>
  Chart.register(Chart.registry.getScale('logarithmic'));

  const allDates = Object.keys(priceData);
  const years = allDates.map(d => parseInt(d.split('-')[0]));
  document.getElementById('startYear').value = Math.min(...years);
  document.getElementById('endYear').value = Math.max(...years);

  function filterByYearRange(start, end) {
    const labels = [], prices = [], eps = [], per = [];
    for (const date in priceData) {
      const year = parseInt(date.split('-')[0]);
      if (year >= start && year <= end && EPSData[date]) {
        labels.push(date);
        prices.push(priceData[date]);
        eps.push(EPSData[date]);
        per.push(EPSData[date] > 0 ? priceData[date] / EPSData[date] : null);
      }
    }
    return { labels, prices, eps, per };
  }

  function drawDoubleChart(canvasId, labelRight, dataRight, labelLeft, dataLeft, colorRight, colorLeft, useLogLeft = false, useLogRight = false) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: shared.labels,
        datasets: [
          {
            label: labelLeft,
            data: dataLeft,
            borderColor: colorLeft,
            yAxisID: 'yLeft',
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: labelRight,
            data: dataRight,
            borderColor: colorRight,
            yAxisID: 'yRight',
            tension: 0.3,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: `${labelLeft} vs ${labelRight}` }
        },
        scales: {
          yLeft: {
            type: useLogLeft ? 'logarithmic' : 'linear',
            position: 'left',
            title: { display: true, text: labelLeft },
            ticks: useLogLeft ? { callback: value => value.toLocaleString() } : undefined
          },
          yRight: {
            type: useLogRight ? 'logarithmic' : 'linear',
            position: 'right',
            title: { display: true, text: labelRight },
            grid: { drawOnChartArea: false },
            ticks: useLogRight ? { callback: value => value.toLocaleString() } : undefined
          },
          x: {
            title: { display: true, text: 'ê¸°ê°„' }
          }
        }
      }
    });
  }



  function pearsonCorrelation(x, y) {
    const n = x.length;
    const avgX = x.reduce((a, b) => a + b, 0) / n;
    const avgY = y.reduce((a, b) => a + b, 0) / n;
    const cov = x.map((xi, i) => (xi - avgX) * (y[i] - avgY)).reduce((a, b) => a + b, 0);
    const stdX = Math.sqrt(x.map(xi => (xi - avgX) ** 2).reduce((a, b) => a + b, 0));
    const stdY = Math.sqrt(y.map(yi => (yi - avgY) ** 2).reduce((a, b) => a + b, 0));
    return cov / (stdX * stdY);
  }

  let chartEPS = null;
  let chartPER = null;
  let shared = {};

  function renderCharts() {
    const start = parseInt(document.getElementById('startYear').value);
    const end = parseInt(document.getElementById('endYear').value);
    const logScale = document.querySelector('input[name="scaleType"]:checked').value === 'log';

    shared = filterByYearRange(start, end);

    if (chartEPS) chartEPS.destroy();
    if (chartPER) chartPER.destroy();

    chartEPS = drawDoubleChart('chartEPS', 'EPS', shared.eps, 'S&P500 ì§€ìˆ˜', shared.prices, '#f28e2b', '#4e79a7', logScale, logScale);
    chartPER = drawDoubleChart('chartPER', 'PER', shared.per, 'S&P500 ì§€ìˆ˜', shared.prices, '#59a14f', '#4e79a7', logScale, false);

    const corr = pearsonCorrelation(shared.prices, shared.eps).toFixed(4);
    const priceStart = shared.prices[0], priceEnd = shared.prices.at(-1);
    const epsStart = shared.eps[0], epsEnd = shared.eps.at(-1);
    const perStart = shared.per[0], perEnd = shared.per.at(-1);
    const priceGrowth = ((priceEnd / priceStart) - 1) * 100;
    const epsGrowth = ((epsEnd / epsStart) - 1) * 100;
    const perGrowth = ((perEnd / perStart) - 1) * 100;

    const epsContribution = epsGrowth / (epsGrowth + perGrowth) * 100;
    const perContribution = perGrowth / (epsGrowth + perGrowth) * 100;

    document.getElementById('analysisText').innerHTML = `
      <strong>ğŸ“Š ë¶„ì„ ê²°ê³¼</strong><br>
      ë¶„ì„ ê¸°ê°„ (${shared.labels[0]} ~ ${shared.labels.at(-1)}) ë™ì•ˆ,<br>
      S&P500 ì§€ìˆ˜ëŠ” <strong>${priceStart.toFixed(2)}</strong> â†’ <strong>${priceEnd.toFixed(2)}</strong> ìƒìŠ¹í•˜ë©° <strong>${priceGrowth.toFixed(2)}%</strong> ì¦ê°€.<br>
      EPS: <strong>${epsStart.toFixed(2)}</strong> â†’ <strong>${epsEnd.toFixed(2)}</strong> (<strong>${epsGrowth.toFixed(2)}%</strong>)<br>
      PER: <strong>${perStart.toFixed(2)}</strong> â†’ <strong>${perEnd.toFixed(2)}</strong> (<strong>${perGrowth.toFixed(2)}%</strong>)<br><br>
      ìƒìŠ¹ ê¸°ì—¬ë„: EPS <strong>${epsContribution.toFixed(1)}%</strong>, PER <strong>${perContribution.toFixed(1)}%</strong><br>
      ìƒê´€ê³„ìˆ˜: <strong>${corr}</strong> â†’ ${corr > 0.7 ? 'ë§¤ìš° ê°•í•œ' : corr > 0.4 ? 'ìƒë‹¹í•œ' : 'ì•½í•œ'} ì–‘ì˜ ìƒê´€ê´€ê³„
    `;
  }

  renderCharts();
</script>
</body>
</html>
