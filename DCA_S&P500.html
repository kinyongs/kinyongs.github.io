<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P500 íˆ¬ì ì‹œë®¬ë ˆì´ì…˜</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div style="text-align: right; margin-bottom: 10px;">
    <a href="index.html">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
  </div>

  <div class="card">
    <h1>ğŸ“ˆ S&P500 íˆ¬ì ì‹œë®¬ë ˆì´ì…˜</h1>
    <p class="description">
      Price ë˜ëŠ” Total Return ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, íˆ¬ì ë°©ì‹(ì¼ì‹œê¸ˆ/ì ë¦½ì‹)ì— ë”°ë¼ ìˆ˜ìµë¥ ì„ ë¶„ì„í•©ë‹ˆë‹¤.
    </p>

    <section style="margin-bottom: 20px; text-align: center;">
      <table style="margin: 0 auto;">
        <tr>
          <th style="text-align: right; padding: 6px 10px;">ğŸ“Š ë°ì´í„° ì„ íƒ</th>
          <td style="text-align: left; padding: 6px 10px;">
            <label><input type="radio" name="dataType" value="price" checked> Price</label>
            <label><input type="radio" name="dataType" value="totalReturn"> Total Return</label>
          </td>
        </tr>
        <tr>
          <th style="text-align: right; padding: 6px 10px;">ğŸ’¼ íˆ¬ì ë°©ì‹</th>
          <td style="text-align: left; padding: 6px 10px;">
            <label><input type="radio" name="investMode" value="dca" checked> ì ë¦½ì‹ íˆ¬ì</label>
            <label><input type="radio" name="investMode" value="lump"> ì¼ì‹œê¸ˆ íˆ¬ì</label>
          </td>
        </tr>
        <tr>
          <th style="text-align: right; padding: 6px 10px;">â³ íˆ¬ì ê¸°ê°„ (ë…„)</th>
          <td style="text-align: left; padding: 6px 10px;">
            <input type="number" id="investmentPeriod" value="20" style="width: 80px;" />
          </td>
        </tr>
      </table>
          <div style="text-align: center; padding: 6px 10px;">
            <button onclick="runSimulation()">ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
          </div>
    </section>

    <div class="chart-wrapper">
      <canvas id="rollingReturnChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <canvas id="histogramChart"></canvas>
    </div>
      <div id="summaryComment" class="comment"></div>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button onclick="location.href='index.html'">ğŸ”™ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>

  <script src="price_totalreturn_monthly.js"></script>
  <script>
    let rollingReturnChartInstance = null;
    let histogramChartInstance = null;

    function calculateMonthlyReturns(data) {
      const keys = Object.keys(data).sort();
      const result = {};
      for (let i = 1; i < keys.length; i++) {
        const prev = data[keys[i - 1]];
        const curr = data[keys[i]];
        if (prev && curr) {
          result[keys[i]] = (curr - prev) / prev;
        }
      }
      return result;
    }

    function runSimulation() {
      const selectedType = document.querySelector('input[name="dataType"]:checked').value;
      const investMode = document.querySelector('input[name="investMode"]:checked').value;
      const baseData = selectedType === 'price' ? priceData : totalReturnData;
      const monthlyReturns = calculateMonthlyReturns(baseData);

      const investmentPeriod = parseInt(document.getElementById('investmentPeriod').value);
      const monthlyInvestment = 1;
      const lumpSumInvestment = 12 * investmentPeriod;
      const keys = Object.keys(monthlyReturns);
      const startMonths = keys.filter((_, idx) => idx + investmentPeriod * 12 <= keys.length);

      const rollingReturns = [];

      for (let i = 0; i < startMonths.length; i++) {
        let principal = 0;
        let value = 0;

        if (investMode === 'dca') {
          // ì ë¦½ì‹ íˆ¬ì
          for (let j = 0; j < investmentPeriod * 12; j++) {
            const idx = i + j;
            const key = keys[idx];
            if (!monthlyReturns[key]) continue;
            principal += monthlyInvestment;
            value = value * (1 + monthlyReturns[key]) + monthlyInvestment;
          }
        } else {
          // ì¼ì‹œê¸ˆ íˆ¬ì
          principal = lumpSumInvestment;
          value = lumpSumInvestment;
          for (let j = 0; j < investmentPeriod * 12; j++) {
            const idx = i + j;
            const key = keys[idx];
            if (!monthlyReturns[key]) continue;
            value *= (1 + monthlyReturns[key]);
          }
        }

        const cagr = (value > 0 && principal > 0) ? Math.pow(value / principal, 1 / investmentPeriod) - 1 : 0;
        rollingReturns.push({ start: keys[i], cagr });
      }

      const labels = rollingReturns.map(e => e.start);
      const cagrData = rollingReturns.map(e => e.cagr * 100);

      if (rollingReturnChartInstance) rollingReturnChartInstance.destroy();
      rollingReturnChartInstance = new Chart(document.getElementById('rollingReturnChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'ì—°í‰ê·  ìˆ˜ìµë¥  (%)',
            data: cagrData,
            borderColor: '#ff7f50',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Rolling Returns (${selectedType}, ${investMode === 'dca' ? 'ì ë¦½ì‹' : 'ì¼ì‹œê¸ˆ'})`
            }
          },
          scales: {
            y: {
              ticks: {
                callback: value => value.toFixed(2) + '%'
              }
            }
          }
        }
      });

      const bins = {};
      rollingReturns.forEach(e => {
        const r = Math.floor(e.cagr * 400) / 4;
        const label = r.toFixed(2);
        bins[label] = (bins[label] || 0) + 1;
      });

      const sortedLabels = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));

      const minCAGR = Math.min(...rollingReturns.map(e => e.cagr));
      const maxCAGR = Math.max(...rollingReturns.map(e => e.cagr));
      const avgCAGR = rollingReturns.reduce((a, b) => a + b.cagr, 0) / rollingReturns.length;

      if (histogramChartInstance) histogramChartInstance.destroy();
      histogramChartInstance = new Chart(document.getElementById('histogramChart'), {
        type: 'bar',
        data: {
          labels: sortedLabels.map(l => l + '%'),
          datasets: [{
            label: 'íšŸìˆ˜',
            data: sortedLabels.map(l => bins[l]),
            backgroundColor: '#6ca0dc',
            maxBarThickness: 30
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `ìˆ˜ìµë¥  ë¶„í¬ (í‰ê·  ${(avgCAGR * 100).toFixed(2)}%, ìµœì†Œ ${(minCAGR * 100).toFixed(2)}%, ìµœëŒ€ ${(maxCAGR * 100).toFixed(2)}%)`
            }
          }
        }
      });

      document.getElementById('summaryComment').innerHTML =
        `ğŸ“Œ ${investmentPeriod}ë…„ê°„ <strong>${investMode === 'dca' ? 'ì ë¦½ì‹' : 'ì¼ì‹œê¸ˆ'}</strong> íˆ¬ì ì‹œ í‰ê·  ì—°ë³µë¦¬ ìˆ˜ìµë¥ ì€ <strong style="color:#d9534f;">${(avgCAGR * 100).toFixed(2)}%</strong>ì´ë©°, ` +
        `ìµœëŒ€ <strong>${(maxCAGR * 100).toFixed(2)}%</strong>, ìµœì†Œ <strong>${(minCAGR * 100).toFixed(2)}%</strong>ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`;
    }

    runSimulation();
  </script>
</body>
</html>
