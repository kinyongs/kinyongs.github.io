<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P500 ì¥ê¸°íˆ¬ì ì‹œ ë†“ì¹œ ë‚ ë“¤ì˜ ì˜í–¥</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script src="price_daily.js"></script>
</head>
<body>

<div id="nav-placeholder"></div>
<script>
  fetch("includes/nav.html")
    .then(response => response.text())
    .then(data => document.getElementById("nav-placeholder").innerHTML = data);
</script>

<div class="card">
  <h1>ğŸ“ˆ S&P 500 ì¥ê¸°íˆ¬ì ì‹œ ë†“ì¹œ ë‚ ë“¤ì˜ ì˜í–¥</h1>
  <p class="note">
    ì¥ê¸°íˆ¬ì ì „ëµì—ì„œ, íŠ¹ì • ë©°ì¹ ì„ ë†“ì¹˜ëŠ” ê²ƒì´ ëˆ„ì  ìˆ˜ìµë¥ ì— ì–¼ë§ˆë‚˜ í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”ì§€ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
  </p>

  <section class="inputs">
    <table>
      <tr>
        <th>ì‹œì‘ ì—°ë„</th>
        <td><input type="number" id="startYear" value="1928" /></td>
      </tr>
      <tr>
        <th>ì¢…ë£Œ ì—°ë„</th>
        <td><input type="number" id="endYear" value="2024" /></td>
      </tr>
      <tr>
        <th>ìµœê³  ìˆ˜ìµì¼ ì œì™¸ (Nì¼)</th>
        <td><input type="number" id="topN" value="10" min="0" /></td>
      </tr>
      <tr>
        <th>ìµœì•… ìˆ˜ìµì¼ ì œì™¸ (Nì¼)</th>
        <td><input type="number" id="bottomM" value="0" min="0" /></td>
      </tr>
      <tr>
        <th>Yì¶• ìŠ¤ì¼€ì¼</th>
        <td>
          <label><input type="radio" name="scaleType" value="linear" checked /> ì„ í˜•</label>
          <label><input type="radio" name="scaleType" value="log" /> ë¡œê·¸</label>
        </td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="drawChart()">ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
    </div>
  </section>

  <div class="chart-wrapper">
    <canvas id="cumulativeChart"></canvas>
  </div>

  <p class="note" style="text-align: center; margin-top: -20px;">
    <span style="color:orange;">ğŸŸ§ ì£¼í™©ìƒ‰ í™”ì‚´í‘œ</span>: ìµœê³  ìˆ˜ìµì¼ ì œì™¸ &nbsp;&nbsp;&nbsp;
    <span style="color:teal;">ğŸŸ¦ ì²­ë¡ìƒ‰ í™”ì‚´í‘œ</span>: ìµœì•… ìˆ˜ìµì¼ ì œì™¸
  </p>

  <section id="summaryText" class="note" style="max-width: 800px; margin: 2rem auto;"></section>

  <div class="card" style="margin-top: 30px;">
    <h3>ğŸ“Š ë†“ì¹œ ë‚  ë¶„ì„ ë¦¬í¬íŠ¸</h3>
    <p class="note">
      ì¥ê¸° íˆ¬ì ì „ëµì—ì„œ ì¼ë¶€ ê±°ë˜ì¼ì„ ë†“ì³¤ì„ ë•Œ ìˆ˜ìµë¥ ì— ì–´ë–¤ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”ì§€ë¥¼<br>
      ë‹¤ì–‘í•œ ì‹œê° ìë£Œì™€ í•¨ê»˜ ìì„¸íˆ ì •ë¦¬í•œ ë¶„ì„ì…ë‹ˆë‹¤.
    </p>
    <a href="./docs/missing-return.html" style="display: inline-block; margin-top: 1rem; padding: 10px 18px; background-color: #2a2a2a; color: #f8f9fa; text-decoration: none; border-radius: 6px; border: 1px solid #666;">
      ì „ì²´ ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°
    </a>
  </div>
</div>


  <script>
    function drawChart() {
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear = parseInt(document.getElementById("endYear").value);
      const topN = Math.max(0, parseInt(document.getElementById("topN").value));
      const bottomM = Math.max(0, parseInt(document.getElementById("bottomM").value));
      const scaleType = document.querySelector('input[name="scaleType"]:checked').value;

      if (startYear < 1928 || endYear > 2024 || startYear > endYear) {
        alert("âš ï¸ ì—°ë„ ë²”ìœ„ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. 1928~2024 ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const entries = Object.entries(priceData)
        .map(([date, price]) => ({ date: new Date(date), price }))
        .filter(d => d.date.getFullYear() >= startYear && d.date.getFullYear() <= endYear)
        .sort((a, b) => a.date - b.date);

      const returns = [];
      for (let i = 1; i < entries.length; i++) {
        const r = (entries[i].price - entries[i - 1].price) / entries[i - 1].price;
        if (Number.isFinite(r)) {
          returns.push({ date: entries[i].date, return: r });
        }
      }

      const shouldOptimize = returns.length >= 3000;

      const sortedReturns = [...returns].sort((a, b) => b.return - a.return);
      const topSlice = topN > 0 ? sortedReturns.slice(0, topN) : [];
      const bottomSlice = bottomM > 0 ? sortedReturns.slice(-bottomM) : [];
      const topDates = new Set(topSlice.map(d => +d.date));
      const bottomDates = new Set(bottomSlice.map(d => +d.date));

      let full = 1;
      let excluded = 1;
      const fullSeries = [];
      const excludedSeries = [];
      const labels = [];
      const annotationLines = [];

      for (let r of returns) {
        full *= (1 + r.return);
        const dateValue = +r.date;
        if (!topDates.has(dateValue) && !bottomDates.has(dateValue)) {
          excluded *= (1 + r.return);
        }
        const dateLabel = r.date.toISOString().slice(0, 10);
        labels.push(dateLabel);
        fullSeries.push(full);
        excludedSeries.push(excluded);

        if (topDates.has(dateValue)) {
          annotationLines.push({
            type: 'label',
            xValue: dateLabel,
            yValue: null,
            content: ['ğŸ¡‡'],
            position: {
              x: 'center',
              y: 'start'
            },
            color: 'orange',
            font: {
              weight: 'bold'
            },
            backgroundColor: 'transparent',
            borderRadius: 0
          });
        }
        if (bottomDates.has(dateValue)) {
          annotationLines.push({
            type: 'label',
            xValue: dateLabel,
            yValue: null,
            content: ['ğŸ¡‡'],
            position: {
              x: 'center',
              y: 'start'
            },
            color: 'teal',
            font: {
              weight: 'bold'
            },
            backgroundColor: 'transparent',
            borderRadius: 0
          });
        }
      }

      const ctx1 = document.getElementById("cumulativeChart").getContext("2d");
      if (window.cumulativeChartInstance) window.cumulativeChartInstance.destroy();

      window.cumulativeChartInstance = new Chart(ctx1, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'ì „ì²´ ë³´ìœ  ì „ëµ',
              data: fullSeries,
              borderColor: '#007bff',
              pointRadius: 0,
              fill: false,
              tension: 0.2
            },
            {
              label: `ìµœê³  ${topN}ì¼ + ìµœì•… ${bottomM}ì¼ ì œì™¸ ì „ëµ`,
              data: excludedSeries,
              borderColor: '#dc3545',
              pointRadius: 0,
              fill: false,
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: shouldOptimize ? false : true,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'yyyy-MM-dd',
                displayFormats: {
                  day: 'yyyy-MM-dd',
                  month: 'yyyy-MM',
                  year: 'yyyy'
                }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 12
              }
            },
            y: {
              type: scaleType === 'log' ? 'logarithmic' : 'linear',
              beginAtZero: false,
              min: Math.min(...excludedSeries.concat(fullSeries)) * 0.95,
              max: Math.max(...excludedSeries.concat(fullSeries)) * 1.05
            }
          },
          plugins: {
            decimation: shouldOptimize ? {
              enabled: true,
              algorithm: 'min-max'
            } : false,
            title: {
              display: true,
              text: "Missing Dateê°€ ì¥ê¸° ìˆ˜ìµë¥ ì— ë¯¸ì¹˜ëŠ” ì˜í–¥"
            },
            annotation: {
              annotations: annotationLines
            }
          }
        },
        plugins: [Chart.registry.getPlugin('annotation')]
      });

      const totalReturn = (full - 1) * 100;
      const excludedReturn = (excluded - 1) * 100;
      const diff = totalReturn - excludedReturn;
      const direction = diff >= 0 ? "ê°ì†Œ" : "ì¦ê°€";

      document.getElementById("summaryText").innerHTML = `
        <p>ì „ì²´ ê¸°ê°„ ë™ì•ˆ ì‹œì¥ì— ê³„ì† íˆ¬ìí•œ ê²½ìš°, ëˆ„ì  ìˆ˜ìµë¥ ì€ <strong>${totalReturn.toFixed(2)}%</strong>ì…ë‹ˆë‹¤.</p>
        <p>ë§Œì•½ ìµœê³  ${topN}ì¼ê³¼ ìµœì•… ${bottomM}ì¼ì„ ë†“ì³¤ë‹¤ë©´, ëˆ„ì  ìˆ˜ìµë¥ ì€ <strong>${excludedReturn.toFixed(2)}%</strong>ì…ë‹ˆë‹¤.</p>
        <p>ì´ë¡œ ì¸í•´ ì¥ê¸° ìˆ˜ìµë¥ ì€ <strong>${Math.abs(diff).toFixed(2)}%</strong>ë§Œí¼ <strong>${direction}</strong>í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
      `;
    }
  drawChart();
  </script>
</body>
</html>
