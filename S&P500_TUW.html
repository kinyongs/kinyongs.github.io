<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>â± Time Under Water (TUW) ë¶„ì„</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script src="price_daily.js"></script>
</head>
<body>
  <div style="text-align: right; margin-bottom: 10px;">
    <a href="index.html">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
  </div>

  <div class="card">
    <h1>ğŸ“‰ S&P500 Time Under Water(TUW) ë¶„ì„</h1>
    <p style="text-align: center; max-width: 720px; margin: 0 auto 1.5rem; font-size: 1rem; color: #555;">
    íˆ¬ì ìì‚°ì´ ê³ ì  ëŒ€ë¹„ ì†ì‹¤ ìƒíƒœì— ë¨¸ë¬¼ëŸ¬ ìˆëŠ” ê¸°ê°„ì„ í™•ì¸í•˜ê³ ,<br />
    <strong>ê°€ì¥ ê¸´ íšŒë³µ ê¸°ê°„ê³¼ ê·¸ ë™ì•ˆì˜ ìµœëŒ€ ì†ì‹¤(MDD)</strong>ì„ ì‹œê°ì ìœ¼ë¡œ ì‚´í´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>


    <section style="margin-bottom: 20px; text-align: center;">
      <table style="margin: 0 auto;">
        <tr>
          <th style="text-align: right; padding: 6px 10px;">ì‹œì‘ ì—°ë„</th>
          <td style="text-align: left; padding: 6px 10px;"><input type="number" id="startYear" value="1928" style="width: 120px;" /></td>
        </tr>
        <tr>
          <th style="text-align: right; padding: 6px 10px;">ì¢…ë£Œ ì—°ë„</th>
          <td style="text-align: left; padding: 6px 10px;"><input type="number" id="endYear" value="2025" style="width: 120px;" /></td>
        </tr>
        <tr>
          <th style="text-align: right; padding: 6px 10px;">ìƒìœ„ í‘œì‹œ ê°œìˆ˜</th>
          <td style="text-align: left; padding: 6px 10px;"><input type="number" id="topK" value="10" min="1" style="width: 120px;" /></td>
        </tr>
        <tr>
          <th style="text-align: right; padding: 6px 10px;">Yì¶• ìŠ¤ì¼€ì¼</th>
          <td style="text-align: left; padding: 6px 10px;">
            <label><input type="radio" name="scaleType" value="linear" checked /> ì„ í˜•</label>
            <label><input type="radio" name="scaleType" value="log" /> ë¡œê·¸</label>
          </td>
        </tr>
      </table>
      <div style="text-align:center; margin-top:1rem;">
        <button onclick="analyzeTUW()">ğŸ“Š TUW ë¶„ì„ ì‹¤í–‰</button>
      </div>
    </section>

    <section class="chart-wrapper">
      <canvas id="tuwChart"></canvas>
    </section>

    <section>
      <table id="tuwTable">
        <thead>
          <tr><th>ì‹œì‘ì¼</th><th>íšŒë³µì¼</th><th>TUW ì¼ìˆ˜</th><th>MDD (%)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <section style="max-width: 700px; margin: 2rem auto; font-size: 0.95rem; line-height: 1.6;" id="summaryText">
    </section>
  
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button onclick="location.href='index.html'">ğŸ”™ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
  
  <script>
    function analyzeTUW() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const topK = parseInt(document.getElementById('topK').value);
      const scaleType = document.querySelector('input[name="scaleType"]:checked').value;
      
      const data = Object.entries(priceData)
        .map(([d, p]) => ({ date: new Date(d), price: p }))
        .filter(d => d.date.getFullYear() >= startYear && d.date.getFullYear() <= endYear)
        .sort((a, b) => a.date - b.date);

      let high = data[0].price;
      let startIdx = 0;
      const tuwList = [];

      for (let i = 1; i < data.length; i++) {
        if (data[i].price > high) {
          high = data[i].price;
          startIdx = i;
        } else {
          let j = i;
          while (j < data.length && data[j].price < high) j++;
          if (j < data.length) {
            const mdd = Math.min(...data.slice(startIdx, j + 1).map(d => d.price)) / high - 1;
            tuwList.push({
              start: data[startIdx].date,
              end: data[j].date,
              days: (data[j].date - data[startIdx].date) / (1000 * 60 * 60 * 24),
              mdd: mdd * 100,
              range: data.slice(startIdx, j + 1)
            });
            i = j;
            high = data[j].price;
            startIdx = j;
          }
        }
      }

      tuwList.sort((a, b) => b.days - a.days);
      const top = tuwList.slice(0, topK);

      const labels = data.map(d => d.date.toISOString().slice(0, 10));
      const prices = data.map(d => d.price);

      const segments = labels.map((_, i) => {
        const date = data[i].date.getTime();
        for (const tuw of top) {
          if (date >= tuw.start.getTime() && date <= tuw.end.getTime()) {
            return true;
          }
        }
        return false;
      });

      const ctx = document.getElementById('tuwChart').getContext('2d');
      if (window.tuwChartInstance) window.tuwChartInstance.destroy();
      window.tuwChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'S&P500 ê°€ê²©',
            data: prices,
            borderColor: '#007bff',
            pointRadius: 0,
            fill: false,
            segment: {
              borderColor: ctx => segments[ctx.p0DataIndex] ? '#ff4d4f' : '#007bff'
            },
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', time: { unit: 'year' } },
            y: {
              type: scaleType === 'log' ? 'logarithmic' : 'linear',
              beginAtZero: false,
              min: Math.min(...prices) * 0.95,
              max: Math.max(...prices) * 1.05
            }
          },
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'ğŸ“‰ Time Under Water êµ¬ê°„ ì‹œê°í™”'
            }
          }
        }
      });

      const tbody = document.querySelector("#tuwTable tbody");
      tbody.innerHTML = "";
      top.forEach(t => {
        const row = `<tr><td>${t.start.toISOString().slice(0,10)}</td><td>${t.end.toISOString().slice(0,10)}</td><td>${t.days.toFixed(0)}</td><td>${t.mdd.toFixed(2)}%</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
      if (top.length > 0) {
        const t = top[0];
        const summary = `
            <p>ğŸ“Œ ê°€ì¥ ê¸´ Time Under Water êµ¬ê°„ì€ <strong>${t.start.toISOString().slice(0, 10)}</strong>ë¶€í„° <strong>${t.end.toISOString().slice(0, 10)}</strong>ê¹Œì§€ ì´ <strong>${t.days.toFixed(0)}ì¼</strong>ê°„ ì§€ì†ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p>ì´ ê¸°ê°„ ì¤‘ ìµœëŒ€ ì†ì‹¤(MDD)ì€ <strong>${t.mdd.toFixed(2)}%</strong>ì…ë‹ˆë‹¤.</p>
        `;
        document.getElementById("summaryText").innerHTML = summary;
    }


    }
    analyzeTUW();
  </script>
</body>
</html>