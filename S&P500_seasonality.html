<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P500 ê³„ì ˆì„± ë¶„ì„</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="price_daily.js"></script>
  <style>
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div style="text-align: right; margin-bottom: 10px;">
    <a href="index.html">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
  </div>

  <div class="card">
    <h1>ğŸ“ˆ S&P500 ê³„ì ˆì„± ë¶„ì„</h1>
    <p style="text-align: center; color: #555; margin-top: -1rem;">
      S&P500ì˜ ì¼ë³„ ëˆ„ì  ìˆ˜ìµë¥ ê³¼ ì›”ë³„ ìš”ì•½ ìˆ˜ìµë¥ ì„ í•¨ê»˜ ì‹œê°í™”í•©ë‹ˆë‹¤.
    </p>

  <section style="margin-bottom: 20px; text-align: center;">
    <table style="margin: 0 auto;">
      <tr>
        <th style="text-align: right; padding: 6px 10px;">â³ ì‹œì‘ ì—°ë„</th>
        <td style="text-align: left; padding: 6px 10px;">
          <input type="number" id="startYear" style="width: 120px;" />
        </td>
      </tr>
      <tr>
        <th style="text-align: right; padding: 6px 10px;">â±ï¸ ì¢…ë£Œ ì—°ë„</th>
        <td style="text-align: left; padding: 6px 10px;">
          <input type="number" id="endYear" style="width: 120px;" />
        </td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 1rem;">
      <button onclick="drawSeasonality()">ğŸ“Š ì°¨íŠ¸ ê·¸ë¦¬ê¸°</button>
    </div>
  </section>


    <section class="chart-wrapper">
      <canvas id="seasonalityChart"></canvas>
    </section>

    <section class="chart-wrapper">
      <canvas id="monthlyChart"></canvas>
    </section>

    <section style="max-width: 700px; margin: 2rem auto; font-size: 0.95rem;">
      <div id="summaryBox" style="color: #333; text-align: left; line-height: 1.6;"></div>
    </section>



  </div>



  <div style="text-align: center; margin-top: 20px;">
    <button onclick="location.href='index.html'">ğŸ”™ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>

  <script>
    function getDayKey(date) {
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    }

    function drawSeasonality() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);

    // ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
    if (startYear < 1928 || endYear > 2024 || startYear > endYear) {
      alert("âš ï¸ ì‹œì‘ ì—°ë„ëŠ” 1928ë…„ ì´ìƒ, ì¢…ë£Œ ì—°ë„ëŠ” 2024ë…„ ì´í•˜ì—¬ì•¼ í•˜ë©°,\nì‹œì‘ ì—°ë„ëŠ” ì¢…ë£Œ ì—°ë„ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

      const totalYears = endYear - startYear + 1;

      const entries = Object.entries(priceData)
        .map(([dateStr, price]) => ({ date: new Date(dateStr), price }))
        .filter(d => {
          const y = d.date.getFullYear();
          return y >= startYear && y <= endYear;
        })
        .sort((a, b) => a.date - b.date);

      const dailyReturnsByYear = {};

      for (let i = 1; i < entries.length; i++) {
        const current = entries[i];
        const prev = entries[i - 1];
        const year = current.date.getFullYear();

        if (prev.date.getFullYear() !== year) continue;

        const r = (current.price - prev.price) / prev.price;
        const key = getDayKey(current.date);
        const month = current.date.getMonth(); // 0~11

        if (!dailyReturnsByYear[year]) dailyReturnsByYear[year] = [];
        dailyReturnsByYear[year].push({ key, return: r, month });
      }

      // ëª¨ë“  ë‚ ì§œ key í™•ë³´
      const allDateKeys = new Set();
      for (const year in dailyReturnsByYear) {
        for (const entry of dailyReturnsByYear[year]) {
          allDateKeys.add(entry.key);
        }
      }
      const dateList = Array.from(allDateKeys).sort();

      // ì „ì¼ ê°’ ìœ ì§€ ëˆ„ì  ìˆ˜ìµë¥ 
      const filledCumulative = {};
      const monthlyReturns = Array(12).fill().map(() => []);

      for (const year in dailyReturnsByYear) {
        const returnMap = Object.fromEntries(dailyReturnsByYear[year].map(e => [e.key, e.return]));
        const monthMap = Object.fromEntries(dailyReturnsByYear[year].map(e => [e.key, e.month]));

        let product = 1;
        for (const day of dateList) {
          if (day in returnMap) {
            product *= (1 + returnMap[day]);
          }
          if (!filledCumulative[day]) filledCumulative[day] = [];
          filledCumulative[day].push(product - 1);

          const m = monthMap[day];
          if (m !== undefined) monthlyReturns[m].push(returnMap[day]);
        }
      }

      // ëˆ„ì  í‰ê·  ìˆ˜ìµë¥ 
      const sortedKeys = dateList;
      const avgCumulative = sortedKeys.map(key => {
        const values = filledCumulative[key]; // ì¡´ì¬í•˜ëŠ” ì—°ë„ì˜ ëˆ„ì  ìˆ˜ìµë¥ ë“¤
        const missingCount = totalYears - values.length;

        // ëˆ„ë½ëœ ì—°ë„ëŠ” ìˆ˜ìµë¥  0% (1.0)ë¡œ ì²˜ë¦¬
        const geoProduct = values.reduce((acc, v) => acc * (1 + v), 1) * Math.pow(1, missingCount);
        const geoMean = Math.pow(geoProduct, 1 / totalYears) - 1;

        return (geoMean * 100).toFixed(2);
      });

      // ì›”ë³„ ìˆ˜ìµë¥  í‰ê·  ê³„ì‚°
      const monthlyAvg = monthlyReturns.map(arr => {
        if (arr.length === 0) return 0;
        const sum = arr.reduce((a, b) => a + b, 0);
        return (sum / arr.length * 100).toFixed(2);
      });

      const ctx1 = document.getElementById("seasonalityChart").getContext("2d");
      const ctx2 = document.getElementById("monthlyChart").getContext("2d");

      if (window.seasonalityChartInstance) window.seasonalityChartInstance.destroy();
      if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();

      window.seasonalityChartInstance = new Chart(ctx1, {
        type: "line",
        data: {
          labels: sortedKeys,
          datasets: [{
            label: `í‰ê·  ëˆ„ì  ìˆ˜ìµë¥  (%) (${startYear}~${endYear})`,
            data: avgCumulative,
            borderColor: "#4e79a7",
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "ğŸ“ˆ ì—°ì¤‘ ëˆ„ì  ìˆ˜ìµë¥  íë¦„"
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'ì›” (Month)'
              },
              ticks: {
                callback: function (value) {
                  const label = this.getLabelForValue(value);
                  const month = label.slice(0, 2);
                  const monthMap = {
                    "01": "Jan", "02": "Feb", "03": "Mar", "04": "Apr",
                    "05": "May", "06": "Jun", "07": "Jul", "08": "Aug",
                    "09": "Sep", "10": "Oct", "11": "Nov", "12": "Dec"
                  };
                  return monthMap[month] || '';
                },
                maxTicksLimit: 12
              }
            },
            y: {
              title: {
                display: true,
                text: 'ëˆ„ì  ìˆ˜ìµë¥  (%)'
              }
            }
          }
        }
      });

      window.monthlyChartInstance = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                   "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
          datasets: [{
            label: `ì›”ë³„ í‰ê·  ìˆ˜ìµë¥  (%)`,
            data: monthlyAvg,
            backgroundColor: "#59a14f"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "ğŸ“Š ì›”ë³„ í‰ê·  ìˆ˜ìµë¥ "
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'í‰ê·  ìˆ˜ìµë¥  (%)'
              }
            }
          }
        }
      });

      // ê²°ê³¼ ìš”ì•½ í…ìŠ¤íŠ¸ ì‘ì„±
      const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”",
                          "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];

      const numericMonthly = monthlyAvg.map(parseFloat);
      const maxVal = Math.max(...numericMonthly);
      const minVal = Math.min(...numericMonthly);
      const maxMonth = monthNames[numericMonthly.indexOf(maxVal)];
      const minMonth = monthNames[numericMonthly.indexOf(minVal)];
      const avgAll = (numericMonthly.reduce((a, b) => a + b, 0) / 12).toFixed(2);
      const avgFirst = (numericMonthly.slice(0, 6).reduce((a, b) => a + b, 0) / 6).toFixed(2);
      const avgSecond = (numericMonthly.slice(6).reduce((a, b) => a + b, 0) / 6).toFixed(2);

      // ì¶œë ¥
      document.getElementById("summaryBox").innerHTML = `
        <p>- í‰ê·  ìˆ˜ìµë¥ ì´ ê°€ì¥ ë†’ì€ ë‹¬ì€ <strong>${maxMonth}</strong>ì´ë©°, <strong>${maxVal.toFixed(2)}%</strong>ì…ë‹ˆë‹¤.</p>
        <p>- í‰ê·  ìˆ˜ìµë¥ ì´ ê°€ì¥ ë‚®ì€ ë‹¬ì€ <strong>${minMonth}</strong>ì´ë©°, <strong>${minVal.toFixed(2)}%</strong>ì…ë‹ˆë‹¤.</p>
        <p>- ì—°ê°„ ì›”í‰ê·  ìˆ˜ìµë¥ ì€ <strong>${avgAll}%</strong>ì…ë‹ˆë‹¤.</p>
        <p>- ìƒë°˜ê¸°(1~6ì›”) í‰ê·  ìˆ˜ìµë¥ ì€ <strong>${avgFirst}%</strong>, í•˜ë°˜ê¸°(7~12ì›”) í‰ê·  ìˆ˜ìµë¥ ì€ <strong>${avgSecond}%</strong>ì…ë‹ˆë‹¤.</p>
      `;


    }
    



    // âœ… í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ì‹¤í–‰
    window.onload = () => {
      const years = Object.keys(priceData).map(dateStr => new Date(dateStr).getFullYear());
      const minYear = Math.min(...years);
      const maxYear = Math.max(...years);
      document.getElementById('startYear').value = minYear+1;
      document.getElementById('endYear').value = maxYear-1;
      drawSeasonality();
    };
  </script>
</body>
</html>
