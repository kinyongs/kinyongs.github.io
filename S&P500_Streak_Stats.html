<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streak Rebound Analysis</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="price_daily.js"></script>
  <style>
    .rise { color: #dc3545; font-weight: bold; }
    .fall { color: #007bff; font-weight: bold; }
    .flat { color: #6c757d; font-weight: bold; }
    td.highlight { font-weight: bold; text-align: right; }
  </style>
</head>
<body>

<div id="nav-placeholder"></div>
<script>
  fetch("includes/nav.html")
    .then(response => response.text())
    .then(data => document.getElementById("nav-placeholder").innerHTML = data);
</script>

<div class="card">
  <h1>ğŸ” ì—°ì† í•˜ë½/ìƒìŠ¹ ë¶„ì„</h1>
  <p class="note">
    S&P500ì˜ ì¼ì¼ ìˆ˜ìµë¥ ì„ ë¶„ì„í•˜ì—¬, ì—°ì† í•˜ë½/ìƒìŠ¹/ì •ì§€ì˜ ë¹ˆë„ì™€ ë‹¤ìŒ ë‚  ìˆ˜ìµë¥  ë°©í–¥ì˜ í™•ë¥ ì„ í†µê³„ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
  </p>

  <section class="inputs">
    <table>
      <tr>
        <th>ì‹œì‘ ì—°ë„</th>
        <td><input type="number" id="startYear" value="2000" /></td>
      </tr>
      <tr>
        <th>ì¢…ë£Œ ì—°ë„</th>
        <td><input type="number" id="endYear" value="2025" /></td>
      </tr>
      <tr>
        <th>0% ìˆ˜ìµë¥  í¬í•¨ ì—¬ë¶€</th>
        <td>
          <label><input type="radio" name="includeZero" value="true" /> í¬í•¨</label>
          <label><input type="radio" name="includeZero" value="false" checked /> ë¬´ì‹œ</label>
        </td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="analyzeStreaks()">ğŸ“Š ë¶„ì„ ì‹¤í–‰</button>
    </div>
  </section>

  <div class="chart-wrapper">
    <canvas id="streakChart"></canvas>
  </div>

  <div class="note" id="textSummary" style="max-width: 800px; margin: 2rem auto; text-align: center;"></div>

  <section id="summaryTable" class="note" style="max-width: 800px; margin: 2rem auto;"></section>
</div>

<script>
  function analyzeStreaks() {
    const startYear = parseInt(document.getElementById("startYear").value);
    const endYear = parseInt(document.getElementById("endYear").value);
    const includeZero = document.querySelector('input[name="includeZero"]:checked').value === "true";
    if (startYear < 1928 || endYear > 2025 || startYear > endYear) {
      alert("âš ï¸ ì—°ë„ ë²”ìœ„ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. 1928~2025 ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const entries = Object.entries(priceData)
      .map(([date, price]) => ({ date: new Date(date), price }))
      .filter(d => d.date.getFullYear() >= startYear && d.date.getFullYear() <= endYear)
      .sort((a, b) => a.date - b.date);

    const returns = [];
    for (let i = 1; i < entries.length; i++) {
      const r = (entries[i].price - entries[i - 1].price) / entries[i - 1].price;
      returns.push({ date: entries[i].date, return: r });
    }

    const streakStats = {};
    let i = 0;
    while (i < returns.length - 1) {
      let direction = null;
      let streakStart = i;
      let streakLength = 1;

      const isUp = r => r > 0;
      const isDown = r => r < 0;
      const isZero = r => r === 0;

      if (isUp(returns[i].return)) direction = "ìƒìŠ¹";
      else if (isDown(returns[i].return)) direction = "í•˜ë½";
      else if (includeZero && isZero(returns[i].return)) direction = "ì •ì§€";
      else { i++; continue; }

      while (i + streakLength < returns.length) {
        const r = returns[i + streakLength].return;
        if ((direction === "ìƒìŠ¹" && isUp(r)) ||
            (direction === "í•˜ë½" && isDown(r)) ||
            (direction === "ì •ì§€" && includeZero && isZero(r))) {
          streakLength++;
        } else {
          break;
        }
      }

      const endIdx = i + streakLength - 1;
      const nextIdx = endIdx + 1;

      if (streakLength >= 1 && nextIdx < returns.length) {
        const nextR = returns[nextIdx].return;
        const label = `${direction} ${streakLength}`;
        if (!streakStats[label]) streakStats[label] = { count: 0 };
        streakStats[label].count++;
      }
      i += streakLength;
    }

    const sortedLabels = Object.keys(streakStats).sort((a, b) => {
      const parse = s => {
        const [dir, n] = s.split(" ");
        return { dir, n: parseInt(n) };
      };
      const aP = parse(a), bP = parse(b);
      const order = { í•˜ë½: 0, ì •ì§€: 1, ìƒìŠ¹: 2 };
      if (aP.dir === bP.dir) return aP.dir === "í•˜ë½" ? bP.n - aP.n : aP.n - bP.n;
      return order[aP.dir] - order[bP.dir];
    });

    const totalCount = Object.values(streakStats).reduce((sum, obj) => sum + obj.count, 0);
    const chartLabels = sortedLabels;
    const chartData = sortedLabels.map(label => (streakStats[label].count / totalCount) * 100);

    const ctx = document.getElementById("streakChart").getContext("2d");
    if (window.streakChartInstance) window.streakChartInstance.destroy();
    window.streakChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'ë°œìƒ í™•ë¥  (%)',
          data: chartData,
          backgroundColor: '#007bff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'ì—°ì† ìƒìŠ¹ / í•˜ë½ / ì •ì§€ ë°œìƒ í™•ë¥ '
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'í™•ë¥  (%)'
            }
          }
        }
      }
    });

  let tableHTML = `<table><thead><tr><th>ì„ íƒ</th><th>íŒ¨í„´</th><th>ì´ ë°œìƒ</th><th>ì´ ë°œìƒ ë¹ˆë„(%)</th></tr></thead><tbody>`;
  sortedLabels.forEach(label => {
    const data = streakStats[label];
    const radioId = `radio_${label.replace(/\s/g, '_')}`;
    const [dir, n] = label.split(" ");
    const isDefault = label === "ìƒìŠ¹ 1" ? "checked" : "";
    const classMap = dir === "ìƒìŠ¹" ? "rise" : dir === "í•˜ë½" ? "fall" : "flat";
    const freq = ((data.count / totalCount) * 100).toFixed(2);
    tableHTML += `<tr>
      <td><input type="radio" name="patternSelect" value="${label}" id="${radioId}" ${isDefault} onchange="updateTextSummary()" /></td>
      <td><label for="${radioId}" class="${classMap}">ì—°ì† ${dir} ${n}ì¼</label></td>
      <td class="highlight">${data.count}</td>
      <td class="highlight">${freq}%</td>
    </tr>`;
  });
  tableHTML += `</tbody></table>`;
  document.getElementById("summaryTable").innerHTML = tableHTML;

  window.streakStats = streakStats;
  window.totalCount = totalCount;
  updateTextSummary();
}

function updateTextSummary() {
  const selected = document.querySelector('input[name="patternSelect"]:checked');
  if (!selected || !window.streakStats) return;

  const label = selected.value;
  const [dir, nStr] = label.split(" ");
  const N = parseInt(nStr);

  let relevant = [];
  if (dir === "ìƒìŠ¹") {
    for (let k in window.streakStats) {
      const [d, m] = k.split(" ");
      if (d === "ìƒìŠ¹" && parseInt(m) >= N + 1) {
        relevant.push(window.streakStats[k].count);
      }
    }
  } else if (dir === "í•˜ë½") {
    for (let k in window.streakStats) {
      const [d, m] = k.split(" ");
      const mNum = parseInt(m);
      if ((d === "í•˜ë½" && mNum <= N - 1) || d === "ìƒìŠ¹") {
        relevant.push(window.streakStats[k].count);
      }
    }
  } else {
    document.getElementById("textSummary").innerHTML = `<span class='flat'>ì •ì§€ íŒ¨í„´ì€ ë‹¤ìŒë‚  ì˜ˆì¸¡ í†µê³„ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>`;
    return;
  }

  const numerator = relevant.reduce((a, b) => a + b, 0);
  const probability = ((numerator / window.totalCount) * 100).toFixed(2);
  const dirClass = dir === "ìƒìŠ¹" ? "rise" : "fall";
  const sentence = `ì˜¤ëŠ˜ê¹Œì§€ <span class='${dirClass}'>ì—°ì† ${dir} ${N}ì¼</span> í–ˆë‹¤ë©´, ë‚´ì¼ ìƒìŠ¹í•  í™•ë¥ ì€ <span class='${dirClass}'>${probability}%</span>ì…ë‹ˆë‹¤.`;
  document.getElementById("textSummary").innerHTML = sentence;
}
analyzeStreaks();
</script>
</body>
</html>