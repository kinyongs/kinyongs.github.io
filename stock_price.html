<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’¾ ë¯¸êµ­ ì£¼ì‹ ì£¼ê°€ ë‹¤ìš´ë¡œë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ë¯¸êµ­ ì£¼ì‹ ì£¼ê°€ ë° Drawdown ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ê³  CSVë¡œ ì €ì¥í•˜ì„¸ìš”. ì¢…ëª© ì½”ë“œ ì…ë ¥ë§Œìœ¼ë¡œ SPY, MSFT ë“± ë¯¸êµ­ ì£¼ê°€ íë¦„ì„ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .summary-box {
      margin-top: 20px;
      background: #f0f4f8;
      padding: 15px;
      border-radius: 8px;
      font-size: 1rem;
      color: #333;
      line-height: 1.6;
    }

    /* .chart-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      margin-top: 40px;
      margin-bottom: 40px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      overflow: visible;
    } */

    /* canvas {
      max-width: 100%;
    } */
  </style>
</head>
<body>

<div id="nav-placeholder"></div>
<script>
  fetch("includes/nav.html")
    .then(response => response.text())
    .then(data => document.getElementById("nav-placeholder").innerHTML = data);
</script>

<div class="card" style="overflow:visible; min-height:auto; height:auto;">
  <h1>ğŸ’¾ ë¯¸êµ­ ì£¼ì‹ ì£¼ê°€ ë‹¤ìš´ë¡œë“œ</h1>
  <p class="note">ì¢…ëª© í‹°ì»¤(Ticker)ë¥¼ ì…ë ¥í•˜ë©´ ì¼ì¼ ì£¼ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³ , Drawdownì„ í¬í•¨í•œ ë¶„ì„ ê·¸ë˜í”„ë¥¼ í™•ì¸í•˜ë©° CSVë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  <p class="note"><i><b>!! ì°¸ê³  !!</b><br>ì£¼ì‹ ë¶„í•  íš¨ê³¼ê°€ ë³´ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <br>ì¼ì¼ ì‚¬ìš©ëŸ‰ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br>S&P500 ì •ë³´ëŠ” "SPY"ë¥¼ ì´ìš©í•˜ì„¸ìš”.</i></p>

  <section class="inputs">
    <table>
      <tr>
        <th>ğŸ” ì¢…ëª© ì‹¬ë³¼</th>
        <td><input type="text" id="symbol" value="MSFT" /></td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="fetchStock()">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
    </div>
  </section>
</div>
  <div class="chart-wrapper" id="chartContainer" style="display: none;">
    <canvas id="stockChart"></canvas>
    <canvas id="drawdownChart"></canvas>

    <div id="downloadContainer" style="text-align: center; margin-top: 20px;">
      <button onclick="downloadCSV()">â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
<!-- </div> -->

<script>
let stockData = [];

async function fetchAPIKey() {
  const response = await fetch("key.dat");
  return (await response.text()).trim();
}

async function fetchStock() {
  const symbol = document.getElementById("symbol").value.toUpperCase();
  const apiKey = await fetchAPIKey();
  const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=full&apikey=${apiKey}`;

  const res = await fetch(url);
  const json = await res.json();

  if (!json["Time Series (Daily)"]) {
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¢…ëª© ì½”ë“œ ë˜ëŠ” API í˜¸ì¶œ ì œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
    return;
  }

  const timeSeries = json["Time Series (Daily)"];
  stockData = Object.entries(timeSeries).map(([date, value]) => ({
    date,
    open: parseFloat(value["1. open"]),
    high: parseFloat(value["2. high"]),
    low: parseFloat(value["3. low"]),
    close: parseFloat(value["4. close"]),
  })).sort((a, b) => new Date(a.date) - new Date(b.date));

  // Drawdown ê³„ì‚°
  let peak = -Infinity;
  stockData.forEach(d => {
    if (d.close > peak) peak = d.close;
    d.drawdown = ((d.close - peak) / peak) * 100;
  });

  drawChart();
  document.getElementById("chartContainer").style.display = "block";
}

function drawChart() {
  const labels = stockData.map(d => d.date);
  const closes = stockData.map(d => d.close);
  const drawdowns = stockData.map(d => d.drawdown);

  // ê¸°ì¡´ ì£¼ê°€ ì°¨íŠ¸ ì œê±°
  if (window.stockChartInstance) window.stockChartInstance.destroy();

  const stockCtx = document.getElementById("stockChart").getContext("2d");
  window.stockChartInstance = new Chart(stockCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'ì¢…ê°€ (Close)',
        data: closes,
        borderColor: '#4e79a7',
        borderWidth: 2,
        fill: false,
        pointRadius: 0,
        tension: 0.1,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'ì£¼ê°€ íë¦„' },
        legend: { position: 'bottom' }
      },
      scales: {
        x: { title: { display: true, text: 'ë‚ ì§œ' } },
        y1: { title: { display: true, text: 'ê°€ê²© ($)' }, position: 'left' }
      }
    }
  });

  // ê¸°ì¡´ ë“œë¡œìš°ë‹¤ìš´ ì°¨íŠ¸ ì œê±°
  if (window.drawdownChartInstance) window.drawdownChartInstance.destroy();

  const ddCtx = document.getElementById("drawdownChart").getContext("2d");
  window.drawdownChartInstance = new Chart(ddCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Drawdown (%)',
        data: drawdowns,
        borderColor: '#e15759',
        backgroundColor: 'rgba(225, 87, 89, 0.2)',
        borderWidth: 1.5,
        fill: true,
        pointRadius: 0,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Drawdown' },
        legend: { position: 'bottom' }
      },
      scales: {
        x: { title: { display: true, text: 'ë‚ ì§œ' } },
        y: {
          title: { display: true, text: 'Drawdown (%)' },
          ticks: {
            callback: value => `${value.toFixed(0)}%`
          }
        }
      }
    }
  });
}

function downloadCSV() {
  if (stockData.length === 0) {
    alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¢…ëª©ì„ ì¡°íšŒí•˜ì„¸ìš”.");
    return;
  }

  let csv = "Date,Open,High,Low,Close,Drawdown (%)\n";
  csv += stockData.map(d =>
    `${d.date},${d.open},${d.high},${d.low},${d.close},${d.drawdown.toFixed(2)}`
  ).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  const symbol = document.getElementById("symbol").value.toUpperCase();
  link.setAttribute("download", `${symbol}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
<script>
  fetch("includes/nav.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("nav-placeholder").innerHTML = data;
      const toggle = document.getElementById('navToggle');
      const links = document.getElementById('navLinks');
      toggle?.addEventListener('click', () => {
        links?.classList.toggle('active');
      });
    });
</script>
</html>
