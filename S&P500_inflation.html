<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P500 vs ë¬¼ê°€ìƒìŠ¹ë¥  ë¶„ì„</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="price_daily.js"></script>
  <script src="CPI.js"></script>
  <style>
    .summary-box {
      margin-top: 30px;
      background: #f0f4f8;
      padding: 15px;
      border-radius: 8px;
      font-size: 1rem;
      color: #333;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  
<div id="nav-placeholder"></div>
<script>
  fetch("includes/nav.html")
    .then(response => response.text())
    .then(data => document.getElementById("nav-placeholder").innerHTML = data);
</script>

<div class="card">
  <h1>ğŸ’° 1ë‹¬ëŸ¬ ê°€ì¹˜ì™€ S&P500 íˆ¬ì ì„±ê³¼ ë¹„êµ</h1>
  <p class="note">
    S&P500ì— íˆ¬ìí•œ ê²°ê³¼ì™€ ì¸í”Œë ˆì´ì…˜ì„ ê³ ë ¤í•œ 1ë‹¬ëŸ¬ ê°€ì¹˜ ë³€í™”ë¥¼ í•¨ê»˜ í™•ì¸í•´ë³´ì„¸ìš”.
  </p>

  <section class="inputs">
    <table>
      <tr>
        <th>â³ ì‹œì‘ ì—°ë„</th>
        <td><input type="number" id="startYear" value="1928" /></td>
      </tr>
      <tr>
        <th>â±ï¸ ì¢…ë£Œ ì—°ë„</th>
        <td><input type="number" id="endYear" value="2024" /></td>
      </tr>
      <tr>
        <th>ğŸ“ˆ ë¬¼ê°€ ìƒìŠ¹ë¥  ì¡°ì •</th>
        <td>
          <label><input type="radio" name="adjustCPI" value="false" checked /> ê³ ë ¤í•˜ì§€ ì•ŠìŒ</label>
          <label><input type="radio" name="adjustCPI" value="true" /> ê³ ë ¤í•¨</label>
        </td>
      </tr>
      <tr>
        <th>ğŸ“ Yì¶• ìŠ¤ì¼€ì¼</th>
        <td>
          <label><input type="radio" name="scaleType" value="linear" checked /> ì„ í˜•</label>
          <label><input type="radio" name="scaleType" value="logarithmic" /> ë¡œê·¸</label>
        </td>
      </tr>
    </table>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="drawComparison()">ğŸ“Š ê·¸ë˜í”„ ê·¸ë¦¬ê¸°</button>
    </div>
  </section>

  <div class="chart-wrapper">
    <canvas id="valueChart"></canvas>
  </div>
  <section id="summaryText" class="note" style="max-width: 800px; margin: 2rem auto;"></section>
</div>

<script>
function drawComparison() {
  const startYear = parseInt(document.getElementById('startYear').value);
  const endYear = parseInt(document.getElementById('endYear').value);
  const adjustCPI = document.querySelector('input[name="adjustCPI"]:checked').value === 'true';
  const scaleType = document.querySelector('input[name="scaleType"]:checked').value;

  if (startYear < 1928 || endYear > 2024 || startYear >= endYear) {
    alert("âš ï¸ ì‹œì‘ ì—°ë„ëŠ” 1928ë…„ ì´ìƒ, ì¢…ë£Œ ì—°ë„ëŠ” 2024ë…„ ì´í•˜ì—¬ì•¼ í•˜ë©°, ì‹œì‘ ì—°ë„ëŠ” ì¢…ë£Œ ì—°ë„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  const entries = Object.entries(priceData)
    .map(([dateStr, price]) => ({ date: new Date(dateStr), price }))
    .filter(d => {
      const y = d.date.getFullYear();
      return y >= startYear && y <= endYear;
    })
    .sort((a, b) => a.date - b.date);

  if (entries.length < 3) return;

  entries.pop(); // ë§ˆì§€ë§‰ ë°ì´í„° ì œê±°

  const firstDate = entries[0].date.toISOString().slice(0, 10);
  const lastDate = entries[entries.length - 1].date.toISOString().slice(0, 10);
  const firstPrice = entries[0].price;
  const firstCPI = const_CPI[firstDate.slice(0, 7) + '-01'] || 100;

  const labels = [];
  const sp500Values = [];
  const dollarValues = [];

  for (const entry of entries) {
    const dateStr = entry.date.toISOString().slice(0, 10);
    const cpiKey = dateStr.slice(0, 7) + '-01';
    const cpiNow = const_CPI[cpiKey] || firstCPI;
    const relativeCPI = cpiNow / firstCPI;

    const growth = entry.price / firstPrice;
    labels.push(dateStr);
    sp500Values.push((adjustCPI ? growth / relativeCPI : growth).toFixed(4));
    dollarValues.push((adjustCPI ? 1 / relativeCPI : 1).toFixed(4));
  }

  if (window.valueChartInstance) window.valueChartInstance.destroy();

  const ctx = document.getElementById("valueChart").getContext("2d");
  window.valueChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: adjustCPI ? "S&P500 ì‹¤ì§ˆ ê°€ì¹˜" : "S&P500 ëª…ëª© ê°€ì¹˜",
          data: sp500Values,
          borderColor: "#4e79a7",
          fill: false,
          tension: 0.1,
          pointRadius: 0
        },
        {
          label: "1ë‹¬ëŸ¬ ê°€ì¹˜",
          data: dollarValues,
          borderColor: "#e15759",
          fill: false,
          tension: 0.1,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: "ğŸ’¹ S&P500 ìˆ˜ìµë¥ ê³¼ 1ë‹¬ëŸ¬ ê°€ì¹˜ ë³€í™”"
        },
        legend: {
          position: 'bottom'
        }
      },
      scales: {
        y: {
          type: scaleType,
          title: {
            display: true,
            text: 'ë°°ìˆ˜ (ê¸°ì¤€ = 1)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'ë‚ ì§œ'
          },
          ticks: {
            maxTicksLimit: 10
          }
        }
      }
    }
  });

  // í…ìŠ¤íŠ¸ ìš”ì•½ ì¶œë ¥
  const sp500Final = sp500Values[sp500Values.length - 1];
  const dollarFinal = dollarValues[dollarValues.length - 1];

  document.getElementById("summaryText").innerHTML = `
    <p>
      ${firstDate}ë¶€í„° ${lastDate}ê¹Œì§€ì˜ ê¸°ê°„ ë™ì•ˆ 
      S&P500ì— <strong>ì¥ê¸° íˆ¬ì</strong>í–ˆì„ ê²½ìš°ì˜ ${adjustCPI ? 'ì‹¤ì§ˆ' : 'ëª…ëª©'} ìˆ˜ìµë¥ ì€ 
      ì•½ <strong>${parseFloat(sp500Final).toFixed(2)}ë°°</strong>ì— ë‹¬í•©ë‹ˆë‹¤.
    </p>
    <p>
      ê°™ì€ ê¸°ê°„ ë™ì•ˆ 1ë‹¬ëŸ¬ì˜ ${adjustCPI ? 'ì‹¤ì§ˆ ê°€ì¹˜' : 'ëª…ëª© ê°€ì¹˜'}ëŠ” 
      <strong>${parseFloat(dollarFinal).toFixed(3)}ë°°</strong>ë¡œ ë³€í™”í•˜ì˜€ìŠµë‹ˆë‹¤.
    </p>
    ${
      adjustCPI
        ? `<p>
            ë¬¼ê°€ ìƒìŠ¹ë¥ ì„ ë°˜ì˜í•˜ë©´, ${firstDate}ì˜ 1ë‹¬ëŸ¬ëŠ” 
            ${lastDate} ê¸°ì¤€ìœ¼ë¡œ ì•½ <strong>${(parseFloat(dollarFinal) * 100).toFixed(1)}ì„¼íŠ¸</strong>ì˜ 
            êµ¬ë§¤ë ¥ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.
          </p>`
        : ''
    }
  `;

}

window.addEventListener("DOMContentLoaded", drawComparison);
</script>
</body>
<script>
  fetch("includes/nav.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("nav-placeholder").innerHTML = data;

      // â¬‡ï¸ ì£¼ì… í›„ toggle ì´ë²¤íŠ¸ ì—°ê²°
      const toggle = document.getElementById('navToggle');
      const links = document.getElementById('navLinks');
      toggle?.addEventListener('click', () => {
        links?.classList.toggle('active');
      });
    });
</script>
</html>
